<% content_for :title do %>
  Unife Study Groups - Nuovo Gruppo
<% end %>

<% content_for :head do %>
  <%= stylesheet_link_tag "dashboard" %>
<% end %>

<div class="bg-light h-100">
  <%= render "nav" %>

  <div class="container-fluid main-container">
    <div class="row h-100">

      <div class="col-md-3 col-lg-3 col-xl-2 h-100 d-none d-md-block pl-2 py-2 pr-0">
        <%= render "user_groups" %>
      </div>

      <div class="col-md-9 col-lg-9 col-xl-10 h-100 p-2">
        <div class="container-fluid h-100 d-flex flex-column px-2 pb-2 pt-0">
          <div class="row flex-shrink-0 d-md-none">
            <div class="col-12">
              <div class="btn-toolbar justify-content-center">
                <%= render "user_groups_modal" %>
              </div>
            </div>
          </div>
          <div class="row flex-grow-1 mt-2">
            <div class="col-12">
              <div class="card card-chat shadow rounded-0 h-100">
                <div class="card-header rounded-0 text-center">Creazione Nuovo Gruppo</div>
                <div class="card-body p-2 d-flex justify-content-center">
                  <div class="mb-2">
                    
                    <%= form_for @group, :html => {class: 'form-new-group'} do |f| %>
                    <%= f.text_field :name, class: 'form-control m-1 rounded-0 shadow-sm', placeholder: "Nome" , required: true %>
                    <%= f.number_field :max_members, class: 'form-control m-1 rounded-0 shadow-sm', placeholder: "Massimo Nr. di Membri", id: "numberBox", value: "" %>
                    <select class="form-control m-1 rounded-0 shadow-sm" id="degree">
                      <option selected>Scegli il Corso di Studio (opzionale)...</option>
                      <% @degrees.each do |degree| %>
                      <option value="<%= degree.id %>" years="<%= degree.years %>"><%= degree.name %></option>
                      <% end %>
                    </select>
                    <%= f.text_area :description, class: 'form-control m-1 rounded-0 shadow-sm', placeholder: "Descrizione", rows: 4 %>
                    <div class="form-check text-center my-3">
                      <label class="form-check-label">
                        <%= f.check_box :private, class: "form-check-input" %>Questo Gruppo Ã© Privato
                      </label>
                    </div>
                    <%= f.submit "Crea Gruppo", :class => "btn btn-lg btn-secondary btn-block m-1 shadow-sm" %>
                    <% end %>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

</div>    

<% content_for :scripts do %>

    <script type="text/javascript">
      function selection (){
        var optionSelected = $('option:selected', this);
        var valueSelected = this.value;
        var yearsSelected = optionSelected.attr('years');
        var yearSelector = $("<select class='form-control m-1 rounded-0 shadow-sm' id='year' required></select>");
        if (typeof yearsSelected !== 'undefined'){
          if ($('#year').length == 0){
            $('#degree').after(yearSelector);
            $('#year').on('change', getCourses);
          }

          if ($('#course').length !== 0)
            $('#course').remove();

          $('#year').empty();

          $('#year').append($('<option>', {
            selected: true,
            text: "Scegli l'Anno...",
          }));
          for (i = 0; i < yearsSelected; i++) {
            $('#year').append($('<option>', {
              value: i + 1,
              text: (i + 1).toString(),
            }));
          }
        } else {
          if ($('#year').length !== 0)
            $('#year').remove();
          if ($('#course').length !== 0)
            $('#course').remove();
        }
      }

      function getCourses (){
        var courseSelector = $('<select class="form-control m-1 rounded-0 shadow-sm" required="required" name="group[course_id]" id="course"></select>');
        if (typeof $('#year').find(':selected').attr('selected') == 'undefined'){
          if ($('#course').length == 0)
            $('#year').after(courseSelector);

          $('#course').empty();

          $('#course').append($('<option>', {
            selected: true,
            text: "Scegli l'Insegnamento...",
          }));

          $.ajax({
            url: "/degrees/" + $('#degree option:selected').val() + "/courses",
            type: 'get',
            data: {
              year: $('#year option:selected').val(),
            },
            success: function(response) {
              for (i=0; i < response.length; i++){
                $('#course').append($('<option>', {
                  value: response[i]['id'],
                  text: response[i]['name'],
                }));
              }
            },
            error: function(xhr) {
            }
          });
        } else {
          if ($('#course').length !== 0)
            $('#course').remove();
        }
      }

      $(document).ready(selection);

      $(document).ready(function(){
        $('#degree').on('change', selection);
      });

    </script>

    <script type="text/javascript">
      $(document).ready(function() {
        $("#numberBox").keydown(function (e) {
              // Allow: backspace, delete, tab, escape, enter and .
              if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                   // Allow: Ctrl/cmd+A
                   (e.keyCode == 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                   // Allow: Ctrl/cmd+C
                   (e.keyCode == 67 && (e.ctrlKey === true || e.metaKey === true)) ||
                   // Allow: Ctrl/cmd+X
                   (e.keyCode == 88 && (e.ctrlKey === true || e.metaKey === true)) ||
                   // Allow: home, end, left, right
                   (e.keyCode >= 35 && e.keyCode <= 39)) {
                       // let it happen, don't do anything
                     return;
                   }
              // Ensure that it is a number and stop the keypress
              if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
              }
            });
      });
    </script>

<% end %>
